---
title: "Mortality prediction using various ABI assessments"
author: "Endre Kolossváry, Tamás Ferenci, Zoltán Járai, Katalin Farkas"
output: github_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, fig.width = 12, dpi = 300,
                      dev = "ragg_png")
library(data.table)
library(ggplot2)
theme_set(theme_bw())
set.seed(1)
repbs <- 1000
source("plotpredicticenReg.R")
```

## Data preprocessing

We first load the data:

```{r}
RawData <- readRDS("../KolossvaryERV-RawData.rds")
```

We carry out the conversion to appropriate interval-censored format:

```{r}
RawData$LastVis <- as.numeric(apply(RawData[
  , c("DATEV1", "DATEV2", "DATEV3", "DATEV4", "DATEV5", "DATEV6")], 1,
  function(x) tail(which(!is.na(x)), 1)))
RawData$LastVisDate <- as.Date(as.character(apply(RawData[
  , c("DATEV1", "DATEV2", "DATEV3", "DATEV4", "DATEV5", "DATEV6")], 1,
  function(x) tail(x[!is.na(x)], 1)), origin = "1970-01-01"))
RawData$BeforeLastVisDate <- as.Date(as.character(apply( RawData[
  , c("DATEV1", "DATEV2", "DATEV3", "DATEV4", "DATEV5", "DATEV6")], 1,
  function(x) tail(x[!is.na(x)], 2)[1]), origin = "1970-01-01"))

RawData$Right <- as.Date(NA)
RawData$Left <- RawData$LastVisDate
RawData$Right[RawData$meghalt==1] <- RawData$LastVisDate[RawData$meghalt==1]
RawData$Left[RawData$meghalt==1] <- RawData$BeforeLastVisDate[RawData$meghalt==1]

RawData$Right <- as.numeric(RawData$Right-RawData$DATEV1)
RawData$Left <- as.numeric(RawData$Left-RawData$DATEV1)

RawData$Right2 <- as.Date(NA)
RawData$Right2[RawData$meghalt==1] <- RawData$LastVisDate[RawData$meghalt==1]
RawData$Left2 <- RawData$LastVisDate

RawData$Right2 <- as.numeric(RawData$Right2-RawData$DATEV1)
RawData$Left2 <- as.numeric(RawData$Left2-RawData$DATEV1)

RawData$tradABI <- pmin(
  pmax(RawData$JdorV1, RawData$JtibV1, na.rm = TRUE)/
    pmax(RawData$BbraV1, RawData$JbraV1, na.rm = TRUE),
  pmax(RawData$BdorV1, RawData$BtibV1, na.rm = TRUE)/
    pmax(RawData$BbraV1, RawData$JbraV1, na.rm = TRUE),
  na.rm = TRUE
)

RawData$alterABI <- pmin(
  pmin(RawData$JdorV1, RawData$JtibV1, na.rm = TRUE)/
    pmax(RawData$BbraV1, RawData$JbraV1, na.rm = TRUE),
  pmin(RawData$BdorV1, RawData$BtibV1, na.rm = TRUE)/
    pmax(RawData$BbraV1, RawData$JbraV1, na.rm = TRUE),
  na.rm = TRUE
)

RawData$tradPAD <- ifelse(RawData$tradABI <= 0.9, 1, 0)
RawData$alterPAD <- ifelse(RawData$alterABI <= 0.9, 1, 0)

RawData$tradABIhigh <- pmax(
  pmax(RawData$JdorV1, RawData$JtibV1, na.rm = TRUE)/
    pmax(RawData$BbraV1, RawData$JbraV1, na.rm = TRUE),
  pmax(RawData$BdorV1, RawData$BtibV1, na.rm = TRUE)/
    pmax(RawData$BbraV1, RawData$JbraV1, na.rm = TRUE),
  na.rm = TRUE
) >= 1.4
RawData$alterABIhigh <- pmax(
  pmin(RawData$JdorV1, RawData$JtibV1, na.rm = TRUE)/
    pmax(RawData$BbraV1, RawData$JbraV1, na.rm = TRUE),
  pmin(RawData$BdorV1, RawData$BtibV1, na.rm = TRUE)/
    pmax(RawData$BbraV1, RawData$JbraV1, na.rm = TRUE),
  na.rm = TRUE
) >= 1.4

RawData$vessels <- 
  (RawData$JdorV1/pmax(RawData$BbraV1, RawData$JbraV1, na.rm = TRUE) <= 0.9) +
  (RawData$JtibV1/pmax(RawData$BbraV1, RawData$JbraV1, na.rm = TRUE) <= 0.9) +
  (RawData$BdorV1/pmax(RawData$BbraV1, RawData$JbraV1, na.rm = TRUE) <= 0.9) +
  (RawData$BtibV1/pmax(RawData$BbraV1, RawData$JbraV1, na.rm = TRUE) <= 0.9)

RawData$Neme <- factor(RawData$Neme, levels = c(0, 1),
                       labels = c("Female", "Male"))

for(var in c("PAD09V1", "SszelutV1", "SinfarktV1", "DIABCOMPLV1",
             "GFR60V1", "tradPAD", "alterPAD")) {
  RawData[[var]] <- factor(RawData[[var]], levels = c(0, 1),
                           labels = c("No", "Yes"))
} 

for(var in c("PADgroupV1", "ScoreV1", "GFRV1", "vessels")) {
  RawData[[var]] <- as.factor(RawData[[var]])
}

names(RawData)[names(RawData) == "TAJszám"] <- "TAJszam"
names(RawData)[names(RawData) == "MagasságVBMI"] <- "MagassagVBMI"
```

## Basic statistics

Number of patients:

```{r}
nrow(RawData)
```

ABI-HIGH:

```{r}
table(RawData$tradPAD)
prop.table(table(RawData$tradPAD))
prop.table(table(RawData[tradPAD == "Yes"]$vessels))*100
```

ABI-LOW:

```{r}
table(RawData$alterPAD)
prop.table(table(RawData$alterPAD))
sum(RawData$tradPAD == "No" & RawData$alterPAD == "Yes")
mean(RawData$tradPAD == "No" & RawData$alterPAD == "Yes")
prop.table(table(RawData[alterPAD == "Yes"]$vessels))*100
```

Supplementary Figure 1:

```{r}
ggplot(melt(RawData[, .(Betegaz, `ABI-HIGH` = tradABI,
                        `ABI-LOW` = alterABI)],
            id.vars = "Betegaz"),
       aes(x = value, color = variable, group = variable)) +
  stat_density(geom = "line", adjust = 2, trim = TRUE) +
  labs(x = "Ankle brachial index", y = "Density", color = "")
```

Supplementary Figure 2:

```{r}
ggplot(RawData, aes(x = tradABI, y = alterABI)) +
  geom_point(size = 0.1, alpha = 0.2) +
  labs(x = "ABI-HIGH", y = "ABI-LOW")
```

Follow-up time statistics:

```{r}
table(is.na(RawData$Right))
prop.table(table(is.na(RawData$Right)))
quantile(RawData[is.na(Right)]$Left)
```

Survival curve:

```{r}
nullmodel <- icenReg::ic_sp(survival::Surv(Left, Right, type = "interval2") ~ 1, data = RawData,
                            model = "ph")

survdat <- with(icenReg::getSCurves(nullmodel),
                data.table(Tbull_ints, surv = S_curves$baseline))
ggplot(melt(survdat[-nrow(survdat)], id.vars = "surv"),
       aes(x = value/365*12, y = surv*100, group = variable)) +
  geom_step() + labs(x = "Time [months]", y = "Survival [%]")
```

Mortality risks:

```{r}
table(is.na(RawData[alterPAD == "No" & alterPAD == "No"]$Right))
prop.table(table(is.na(RawData[alterPAD == "No" & alterPAD == "No"]$Right)))
table(is.na(RawData[tradPAD == "Yes"]$Right))
prop.table(table(is.na(RawData[tradPAD == "Yes"]$Right)))
table(is.na(RawData[alterPAD == "Yes" & tradPAD == "No"]$Right))
prop.table(table(is.na(RawData[alterPAD == "Yes" & tradPAD == "No"]$Right)))
```

Mortality rates:

```{r}
RawData$FU <- ifelse(is.na(RawData$Right), RawData$Left, (RawData$Right + RawData$Left)/2) / 365.241
quantile(RawData$FU)
RawData[, .(sum(!is.na(Right))/sum(FU) * 1000)]
RawData[alterPAD == "No" & tradPAD == "No", .(sum(!is.na(Right))/sum(FU) * 1000)]
RawData[tradPAD == "Yes", .(sum(!is.na(Right))/sum(FU) * 1000)]
RawData[alterPAD == "Yes" & tradPAD == "No", .(sum(!is.na(Right))/sum(FU) * 1000)]
```

## Multivariable model (full dataset)

Preparing the data:

```{r}
RawData <- RawData[, c(
  "Betegaz", "Left", "Right", "Neme", "AGE", "DIABCOMPLV1", "SinfarktV1",
  "SszelutV1", "BMIV1", "GFR60V1", "RRsystV1", "RRdiastV1",
  "tradABI", "tradPAD", "alterABI",  "alterPAD", "vessels")]
RawData <- na.omit(RawData, cols = c(2, 4:ncol(RawData)))
```

### Null model

Interval-censored survival models:

```{r}
baseformula <- as.formula("survival::Surv(Left, Right, type = 'interval2') ~ 1")

myClust <- parallel::makeCluster(parallel::detectCores() - 1)
doParallel::registerDoParallel(myClust)

model0 <- icenReg::ic_sp(baseformula, data = RawData,
                         model = "ph", bs_samples = repbs, useMCores = TRUE)

model1 <- icenReg::ic_sp(update(baseformula, ~ . + tradPAD), data = RawData,
                         model = "ph", bs_samples = repbs, useMCores = TRUE)

model2 <- icenReg::ic_sp(update(baseformula, ~ . + splines::ns(tradABI, df = 4)), data = RawData,
                         model = "ph", bs_samples = repbs, useMCores = TRUE)

model3 <- icenReg::ic_sp(update(baseformula, ~ . + alterPAD), data = RawData,
                         model = "ph", bs_samples = repbs, useMCores = TRUE)

model4 <- icenReg::ic_sp(update(baseformula, ~ . + splines::ns(alterABI, df = 4)), data = RawData,
                         model = "ph", bs_samples = repbs, useMCores = TRUE)

model5 <- icenReg::ic_sp(update(baseformula, ~ . + vessels), data = RawData,
                         model = "ph", bs_samples = repbs, useMCores = TRUE)

parallel::stopCluster(myClust)

fits <- list(model0, model1, model2, model3, model4, model5)
```

Models:

```{r}
lapply(1:length(fits), function(i) {
  res <- data.frame(HR = exp(coef(fits[[i]])), exp(confint(fits[[i]])),
                    p = summary(fits[[i]])$summaryParameters[, 5])
  res <- res[!grepl("ns(", row.names(res), fixed = TRUE),]
  res$Variable <- row.names(res)
  res
})
```

Adequacy indices and fractions of new information:

```{r}
data.table(
  Name = c("Base", paste0("Model ", 1:5)),
  LR_Chi2 = sapply(1:6, function(i) 2*(fits[[i]]$llk - nullmodel$llk)),
  AdequacyIndex = sapply(1:6, function(i) (fits[[1]]$llk - nullmodel$llk)/(fits[[i]]$llk - nullmodel$llk)),
  FracNewInf = sapply(1:6, function(i) 1-(fits[[1]]$llk - nullmodel$llk)/(fits[[i]]$llk - nullmodel$llk))
)
```

Effect of ABI-HIGH and ABI-LOW:

```{r}
predfit3 <- pred(fits[[3]], cont.quant.limit = c(0.01, 0.99))
predfit3 <- predfit3[order(predfit3$var, as.numeric(predfit3$x)),]
lrtestfit3 <- lrtesticenReg(fits[[3]], 1)
predfit5 <- pred(fits[[5]], cont.quant.limit = c(0.01, 0.99))
predfit5 <- predfit5[order(predfit5$var, as.numeric(predfit5$x)),]
lrtestfit5 <- lrtesticenReg(fits[[5]], 1)

predfit3 <- predfit3[predfit3$var == "tradABI",]
predfit3$var <- "ABI-HIGH"
rownames(lrtestfit3) <- "splines::ns(ABI-HIGH, df = 4)"
predfit5 <- predfit5[predfit5$var == "alterABI",]
predfit5$var <- "ABI-LOW"
rownames(lrtestfit5) <- "splines::ns(ABI-LOW, df = 4)"

plotpred(predfit3, ci.type = "bs", lrtest = lrtestfit3, xlab = "ABI-HIGH")
plotpred(predfit5, ci.type = "bs", lrtest = lrtestfit5, xlab = "ABI-LOW")
```

ROC curve:

```{r}
pargrid <- CJ(model = 2:length(fits), year = 3)

if(!file.exists("tempIntROC_ures.rds")) {
  myClust <- parallel::makeCluster(parallel::detectCores() - 1)
  parallel::clusterExport(myClust, c("RawData", "fits", "pargrid"))
  
  temp <- rbindlist(parallel::parLapply(myClust, 1:nrow(pargrid), function(i)
    cbind(with(cenROC::IntROC(RawData$Left, ifelse(is.na(RawData$Right), Inf, RawData$Right), predict(fits[[ pargrid$model[i] ]], type = "lp"), pargrid$year[i] * 365),
               data.table::data.table(Sp = 1 - U, Se = ROC, AUC["AUC"])), model = pargrid$model[i] - 1, year = pargrid$year[i])))
  
  parallel::stopCluster(myClust)
  
} else temp <- readRDS("tempIntROC_ures.rds")

ggplot(temp, aes(x = 1 - Sp, y = Se, group = factor(model), color = factor(model))) +
  geom_line() + geom_abline() + labs(color = "Model")
```

AUCs:

```{r}
unique(temp[, .(model, AUC)])
```

### All covariates

Interval-censored survival models:

```{r}
baseformula <- as.formula("survival::Surv(Left, Right, type = 'interval2') ~
                            Neme + splines::ns(AGE, df = 4) + SinfarktV1 + SszelutV1 +
                            DIABCOMPLV1 + GFR60V1 + splines::ns(RRsystV1, df = 4) +
                            splines::ns(RRdiastV1, df = 4) + splines::ns(BMIV1, df = 4)")

myClust <- parallel::makeCluster(parallel::detectCores() - 1)
doParallel::registerDoParallel(myClust)

model0 <- icenReg::ic_sp(baseformula, data = RawData,
                         model = "ph", bs_samples = repbs, useMCores = TRUE)

model1 <- icenReg::ic_sp(update(baseformula, ~ . + tradPAD), data = RawData,
                         model = "ph", bs_samples = repbs, useMCores = TRUE)

model2 <- icenReg::ic_sp(update(baseformula, ~ . + splines::ns(tradABI, df = 4)), data = RawData,
                         model = "ph", bs_samples = repbs, useMCores = TRUE)

model3 <- icenReg::ic_sp(update(baseformula, ~ . + alterPAD), data = RawData,
                         model = "ph", bs_samples = repbs, useMCores = TRUE)

model4 <- icenReg::ic_sp(update(baseformula, ~ . + splines::ns(alterABI, df = 4)), data = RawData,
                         model = "ph", bs_samples = repbs, useMCores = TRUE)

model5 <- icenReg::ic_sp(update(baseformula, ~ . + vessels), data = RawData,
                         model = "ph", bs_samples = repbs, useMCores = TRUE)

parallel::stopCluster(myClust)

fits <- list(model0, model1, model2, model3, model4, model5)
```

Models:

```{r}
lapply(1:length(fits), function(i) {
  res <- data.frame(HR = exp(coef(fits[[i]])), exp(confint(fits[[i]])),
                    p = summary(fits[[i]])$summaryParameters[, 5])
  res <- res[!grepl("ns(", row.names(res), fixed = TRUE),]
  res$Variable <- row.names(res)
  res
})
```

Adequacy indices and fractions of new information:

```{r}
data.table(
  Name = c("Base", paste0("Model ", 1:5)),
  LR_Chi2 = sapply(1:6, function(i) 2*(fits[[i]]$llk - nullmodel$llk)),
  AdequacyIndex = sapply(1:6, function(i) (fits[[1]]$llk - nullmodel$llk)/(fits[[i]]$llk - nullmodel$llk)),
  FracNewInf = sapply(1:6, function(i) 1-(fits[[1]]$llk - nullmodel$llk)/(fits[[i]]$llk - nullmodel$llk))
)
```

Effect of ABI-HIGH and ABI-LOW:

```{r}
predfit3 <- pred(fits[[3]], cont.quant.limit = c(0.01, 0.99))
predfit3 <- predfit3[order(predfit3$var, as.numeric(predfit3$x)),]
lrtestfit3 <- lrtesticenReg(fits[[3]], 10)
predfit5 <- pred(fits[[5]], cont.quant.limit = c(0.01, 0.99))
predfit5 <- predfit5[order(predfit5$var, as.numeric(predfit5$x)),]
lrtestfit5 <- lrtesticenReg(fits[[5]], 10)

predfit3 <- predfit3[predfit3$var == "tradABI",]
predfit3$var <- "ABI-HIGH"
rownames(lrtestfit3) <- "splines::ns(ABI-HIGH, df = 4)"
predfit5 <- predfit5[predfit5$var == "alterABI",]
predfit5$var <- "ABI-LOW"
rownames(lrtestfit5) <- "splines::ns(ABI-LOW, df = 4)"

plotpred(predfit3, ci.type = "bs", lrtest = lrtestfit3, xlab = "ABI-HIGH")
plotpred(predfit5, ci.type = "bs", lrtest = lrtestfit5, xlab = "ABI-LOW")
```

ROC curve:

```{r}
pargrid <- CJ(model = 2:length(fits), year = 3)

if(!file.exists("tempIntROC.rds")) {
  myClust <- parallel::makeCluster(parallel::detectCores() - 1)
  parallel::clusterExport(myClust, c("RawData", "fits", "pargrid"))
  
  temp <- rbindlist(parallel::parLapply(myClust, 1:nrow(pargrid), function(i)
    cbind(with(cenROC::IntROC(RawData$Left, ifelse(is.na(RawData$Right), Inf, RawData$Right), predict(fits[[ pargrid$model[i] ]], type = "lp"), pargrid$year[i] * 365),
               data.table::data.table(Sp = 1 - U, Se = ROC, AUC["AUC"])), model = pargrid$model[i] - 1, year = pargrid$year[i])))
  
  parallel::stopCluster(myClust)
  
} else temp <- readRDS("tempIntROC.rds")

ggplot(temp, aes(x = 1 - Sp, y = Se, group = factor(model), color = factor(model))) +
  geom_line() + geom_abline() + labs(color = "Model")
```

AUCs:

```{r}
unique(temp[, .(model, AUC)])
```

## Multivariable model (tradPAD-negative only)

### Null model

Data preparation:

```{r}
RawData2 <- RawData[tradPAD == "No"]
RawData2$vessels <- droplevels(RawData2$vessels)
nrow(RawData2)
```

Estimating the models:

```{r}
baseformula <- as.formula("survival::Surv(Left, Right, type = 'interval2') ~ 1")

myClust <- parallel::makeCluster(parallel::detectCores() - 1)
doParallel::registerDoParallel(myClust)

model0 <- icenReg::ic_sp(baseformula, data = RawData2,
                         model = "ph", bs_samples = repbs, useMCores = TRUE)

model3 <- icenReg::ic_sp(update(baseformula, ~ . + alterPAD), data = RawData2,
                         model = "ph", bs_samples = repbs, useMCores = TRUE)

model4 <- icenReg::ic_sp(update(baseformula, ~ . + splines::ns(alterABI, df = 4)), data = RawData2,
                         model = "ph", bs_samples = repbs, useMCores = TRUE)

model5 <- icenReg::ic_sp(update(baseformula, ~ . + vessels), data = RawData2,
                         model = "ph", bs_samples = repbs, useMCores = TRUE)

parallel::stopCluster(myClust)

fits <- list(model0, model3, model4, model5)
```

AUCs:

```{r}
pargrid <- CJ(model = 2:length(fits), year = 3)

if(!file.exists("tempIntROC_ures_onlyNonTradPAD.rds")) {
  myClust <- parallel::makeCluster(parallel::detectCores() - 1)
  parallel::clusterExport(myClust, c("RawData2", "fits", "pargrid"))
  
  temp <- rbindlist(parallel::parLapply(myClust, 1:nrow(pargrid), function(i)
    cbind(with(cenROC::IntROC(RawData2$Left, ifelse(is.na(RawData2$Right), Inf, RawData2$Right), predict(fits[[ pargrid$model[i] ]], type = "lp"), pargrid$year[i] * 365),
               data.table::data.table(Sp = 1 - U, Se = ROC, AUC["AUC"])), model = pargrid$model[i] - 1, year = pargrid$year[i])))
  
  parallel::stopCluster(myClust)
  
} else temp <- readRDS("tempIntROC_ures_onlyNonTradPAD.rds")

unique(temp[, .(model, AUC)])
```

## Multivariable model (diabetic only)

### Null model

Data preparation:

```{r}
RawData2 <- RawData[DIABCOMPLV1 == "Yes"]
RawData2$vessels <- droplevels(RawData2$vessels)
nrow(RawData2)
```

Estimating the models:

```{r}
baseformula <- as.formula("survival::Surv(Left, Right, type = 'interval2') ~ 1")

myClust <- parallel::makeCluster(parallel::detectCores() - 1)
doParallel::registerDoParallel(myClust)

model0 <- icenReg::ic_sp(baseformula, data = RawData2,
                         model = "ph", bs_samples = repbs, useMCores = TRUE)

model1 <- icenReg::ic_sp(update(baseformula, ~ . + tradPAD), data = RawData2,
                         model = "ph", bs_samples = repbs, useMCores = TRUE)

model2 <- icenReg::ic_sp(update(baseformula, ~ . + splines::ns(tradABI, df = 4)), data = RawData2,
                         model = "ph", bs_samples = repbs, useMCores = TRUE)

model3 <- icenReg::ic_sp(update(baseformula, ~ . + alterPAD), data = RawData2,
                         model = "ph", bs_samples = repbs, useMCores = TRUE)

model4 <- icenReg::ic_sp(update(baseformula, ~ . + splines::ns(alterABI, df = 4)), data = RawData2,
                         model = "ph", bs_samples = repbs, useMCores = TRUE)

model5 <- icenReg::ic_sp(update(baseformula, ~ . + vessels), data = RawData2,
                         model = "ph", bs_samples = repbs, useMCores = TRUE)

parallel::stopCluster(myClust)

fits <- list(model0, model1, model2, model3, model4, model5)
```

AUCs:

```{r}
pargrid <- CJ(model = 2:length(fits), year = 3)

if(!file.exists("tempIntROC_ures_onlyDiabetic.rds")) {
  myClust <- parallel::makeCluster(parallel::detectCores() - 1)
  parallel::clusterExport(myClust, c("RawData2", "fits", "pargrid"))
  
  temp <- rbindlist(parallel::parLapply(myClust, 1:nrow(pargrid), function(i)
    cbind(with(cenROC::IntROC(RawData2$Left, ifelse(is.na(RawData2$Right), Inf, RawData2$Right), predict(fits[[ pargrid$model[i] ]], type = "lp"), pargrid$year[i] * 365),
               data.table::data.table(Sp = 1 - U, Se = ROC, AUC["AUC"])), model = pargrid$model[i] - 1, year = pargrid$year[i])))
  
  parallel::stopCluster(myClust)
  
  saveRDS(temp, "tempIntROC_ures_onlyDiabetic.rds")
  
} else temp <- readRDS("tempIntROC_ures_onlyDiabetic.rds")

unique(temp[, .(model, AUC)])
```